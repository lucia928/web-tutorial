# 虚拟DOM

- *虚拟DOM*（Virtual DOM）是*Vue*实现高效渲染的核心机制，是对*真实DOM节点*的抽象，用J*S对象属性*来描述*真实DOM节点*，*虚拟DOM对象的节点属性*与*真实DOM属性*一一对应，最终可以构建一颗*真正的DOM树*插入到文档中；在*JS对象*中，*虚拟DOM*表现为一个*Object对象*，并且最少包含*标签名tag*、*属性attrs*和*子元素对象children*三个属性。

- *虚拟 DOM* 最大的优势在于抽象了原本的渲染过程，实现了跨平台的能力，而不仅仅局限于浏览器的 DOM，可以是安卓和 IOS 的原生组件，可以是小程序。

- **虚拟DOM工作原理： ** 解析模板编译为渲染函数 -> 生成VNode树 -> 对比新旧VNode -> 计算最小DOM操作 -> 更新真实DOM。

- **核心优势：**
  - **批量更新：** 合并多次数据变更，减少DOM操作次数。
  - **差异对比：** 通过Diff算法精确找出需要更新的节点。
  - **跨平台能力：** 同一套VNode可以渲染到Web/Native等不同环境。

## Diff算法

- *Diff 算法*是一种对比算法，通过比较*新旧虚拟DOM*，得出哪个*虚拟DOM*发生了改变，再找出这个*虚拟DOM*对应的*真实节点*并且更新，而不用更新其他未发生改变的节点，实现精准地*更新真实DOM*，进而提升效率。

- **核心策略：**

  - **同级比较：** 
    - 只比较相同层级的节点，不比较跨层级比较（避免树结构的递归开销）。
    - 节点类型不同时直接销毁重建。
    - 节点类型相同时复用DOM元素
    - 同级比较时，循环从两边向中间收拢（四指针交叉对比、乱序key对比）。

- **原理分析：**

  当数据发生变化时，*setter方法*会通知所有订阅者，订阅者就会调用*patch函数*给*真实DOM*打补丁，更新相应视图。
  
  *patch函数*前两个参数为`oldVNode` 和 `VNode`，分别代表新的节点和旧节点，主要做了以下四件事：
  
  - 创建节点：没有旧节点（页面初始化），直接调用`createElm`创建。
  - 删除节点：没有新节点，直接移除旧节点`removeNode。`
  - 更新节点：
    - 新旧节点一样（`sameVnode`）,调用`patchVnode`处理。
    - 新旧节点不一样，删除旧节点，创建新节点。

## key的作用

- `key`是给一个`Vnode`的`唯一ID`，在`patch`过程中通过`key`可以精准判断两个节点是否是同一个，从而避免频繁更新不同元素，使得整个`patch`过程更加高效，减少`DOM操作量`，提高性能。
- 如果不用`key`，Vue会用一种`最大减少动态元素`并且尽可能尝试`就地复用`的算法，不会删除和添加节点，只是去修改已有节点的，但操作节点是十分耗费性能的；而使用`key`的时候，会基于`key`的变化重新排列元素的顺序，移除`key`不存在的元素。
